name: Docker CI/CD

on:
  push:
    branches: [ dev, leroy-jenkins/full-send ]
  pull_request:
    branches: [ dev, leroy-jenkins/full-send ]
  release:
    types: [ published ]

jobs:
  test-dev:
    name: Test Development Container
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Free up disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        docker system prune -af
        df -h

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build dev container (verify Dockerfile)
      run: |
        docker buildx build \
          --file Dockerfile.dev \
          --tag antibody-dev:test \
          --cache-from type=gha \
          --cache-to type=gha,mode=max \
          .
      # Note: We skip --load to avoid "no space left" errors on GitHub runners
      # The build includes RUN pytest which validates tests pass during build
      # Local testing with full image load is still required before merging

  test-prod:
    name: Test Production Container
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Free up disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        docker system prune -af
        df -h

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build production container (verify Dockerfile)
      run: |
        docker buildx build \
          --file Dockerfile.prod \
          --tag antibody-prod:test \
          --cache-from type=gha \
          --cache-to type=gha,mode=max \
          .
      # Note: We skip --load to avoid "no space left" errors on GitHub runners
      # The build includes RUN pytest which validates tests pass during build
      # Production image is 11.7GB - too large for GitHub Actions disk space

  build-and-push:
    name: Build and Push Production Image
    runs-on: ubuntu-latest
    if: (github.event_name == 'push' && github.ref == 'refs/heads/leroy-jenkins/full-send') || github.event_name == 'release'
    needs: [test-dev, test-prod]
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract version from pyproject.toml
      id: version
      run: |
        VERSION=$(grep -E '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Detected version: $VERSION"

    - name: Set lowercase repository owner
      run: echo "OWNER_LC=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

    - name: Build and push production image
      id: docker_build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.prod
        push: true
        build-args: |
          VERSION=${{ steps.version.outputs.version }}
        tags: |
          ghcr.io/${{ env.OWNER_LC }}/antibody-training:latest
          ghcr.io/${{ env.OWNER_LC }}/antibody-training:${{ steps.version.outputs.version }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Image digest
      run: echo "Image pushed successfully with digest ${{ steps.docker_build.outputs.digest }}"
