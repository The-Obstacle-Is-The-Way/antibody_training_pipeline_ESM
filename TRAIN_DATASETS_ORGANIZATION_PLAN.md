# Training Datasets Organization Plan

**Date:** November 5, 2025
**Status:** ğŸ“‹ PLANNING - Awaiting Senior Approval
**Purpose:** Reorganize `train_datasets/` to match the clean dataset-centric structure we established for `test_datasets/`

---

## Current State Analysis

### Current Structure (Messy ğŸ˜µ)

```
train_datasets/
â”œâ”€â”€ BOUGHTER_DATA_PROVENANCE.md          â† Good! Keep this
â”œâ”€â”€ boughter.csv                          â† Stage 1 output (1,117 sequences)
â”œâ”€â”€ boughter_raw/                         â† Raw DNA files (19 files)
â”‚   â”œâ”€â”€ flu_fastaH.txt
â”‚   â”œâ”€â”€ flu_fastaL.txt
â”‚   â”œâ”€â”€ flu_NumReact.txt
â”‚   â”œâ”€â”€ ... (16 more files)
â”‚   â””â”€â”€ translation_failures.log
â””â”€â”€ boughter/                             â† Stages 2+3 outputs
    â”œâ”€â”€ VH_only_boughter.csv              â† 16 fragment CSVs (1,065 sequences each)
    â”œâ”€â”€ VH_only_boughter_training.csv     â† Training subset (914 sequences)
    â”œâ”€â”€ VH_only_boughter_strict_qc.csv    â† Stage 4 strict QC (16 files)
    â”œâ”€â”€ ... (48 more fragment files)
    â”œâ”€â”€ annotation_failures.log
    â”œâ”€â”€ qc_filtered_sequences.txt
    â”œâ”€â”€ validation_report.txt
    â””â”€â”€ README.md
```

### Problems Identified ğŸš¨

1. **`boughter.csv` is floating at top level** - Should be in `boughter/` directory
2. **No clear `raw/` â†’ `processed/` â†’ `fragments/` organization** - Unlike test_datasets
3. **Mixed pipeline stages in one directory** - Hard to trace provenance
4. **No `canonical/` directory** - Where's the authoritative training file?
5. **Strict QC files mixed with standard files** - Should be in separate subdirectory or clearly marked
6. **No visual consistency with `test_datasets/` structure** - Makes navigation confusing

---

## Proposed Structure (Clean! ğŸ”¥)

### Option A: Full Pipeline Visibility (RECOMMENDED)

**Philosophy:** Make every processing stage explicit in the directory structure

```
train_datasets/
â”œâ”€â”€ README.md                             â† Overview of ALL training datasets
â”œâ”€â”€ BOUGHTER_DATA_PROVENANCE.md          â† Keep at root (references all subdirs)
â”‚
â””â”€â”€ boughter/                             â† ONE directory = ONE dataset
    â”œâ”€â”€ README.md                         â† Boughter-specific docs
    â”‚
    â”œâ”€â”€ raw/                              â† Stage 0: Raw DNA from AIMS_manuscripts
    â”‚   â”œâ”€â”€ flu_fastaH.txt                â”‚  (19 files, byte-for-byte identical to source)
    â”‚   â”œâ”€â”€ flu_fastaL.txt                â”‚
    â”‚   â”œâ”€â”€ flu_NumReact.txt              â”‚
    â”‚   â”œâ”€â”€ ... (16 more files)           â”‚
    â”‚   â””â”€â”€ translation_failures.log      â† Generated by Stage 1
    â”‚
    â”œâ”€â”€ processed/                        â† Stage 1: Translated protein sequences
    â”‚   â””â”€â”€ boughter.csv                  â”‚  (1,117 sequences)
    â”‚
    â”œâ”€â”€ annotated/                        â† Stages 2+3: ANARCI-annotated fragments
    â”‚   â”œâ”€â”€ VH_only_boughter.csv          â”‚  (16 fragment types Ã— 1,065 sequences)
    â”‚   â”œâ”€â”€ VL_only_boughter.csv          â”‚
    â”‚   â”œâ”€â”€ H-CDR1_boughter.csv           â”‚
    â”‚   â”œâ”€â”€ ... (13 more fragment files)  â”‚
    â”‚   â”œâ”€â”€ annotation_failures.log       â”‚
    â”‚   â”œâ”€â”€ qc_filtered_sequences.txt     â”‚
    â”‚   â””â”€â”€ validation_report.txt         â”‚
    â”‚
    â”œâ”€â”€ canonical/                        â† Stage 3 final: Authoritative training files
    â”‚   â”œâ”€â”€ VH_only_boughter_training.csv â”‚  â† PRIMARY TRAINING FILE (914 sequences)
    â”‚   â””â”€â”€ README.md                     â”‚  â† Explains Novo flagging (0 flags, 4+ flags)
    â”‚
    â””â”€â”€ strict_qc/                        â† Stage 4 optional: Additional QC experiments
        â”œâ”€â”€ VH_only_boughter_strict_qc.csvâ”‚  (16 strict QC files, if needed)
        â”œâ”€â”€ ... (15 more strict QC files) â”‚
        â””â”€â”€ README.md                     â”‚  â† Explains strict QC criteria
```

**Pros:**
- âœ… Clear stage progression: `raw/` â†’ `processed/` â†’ `annotated/` â†’ `canonical/`
- âœ… Easy to trace any file's provenance
- âœ… Separates experimental files (`strict_qc/`) from production files
- âœ… `canonical/` makes it obvious which file to use for training
- âœ… Mirrors the clarity of `test_datasets/` structure

**Cons:**
- Requires moving many files (but we have `git mv` for history preservation!)

---

### Option B: Minimal Reorganization (Simpler)

**Philosophy:** Keep it simple, just organize the key outputs

```
train_datasets/
â”œâ”€â”€ README.md
â”œâ”€â”€ BOUGHTER_DATA_PROVENANCE.md
â”‚
â””â”€â”€ boughter/
    â”œâ”€â”€ README.md
    â”‚
    â”œâ”€â”€ raw/                              â† Stage 0: Raw DNA
    â”‚   â””â”€â”€ ... (19 files)
    â”‚
    â”œâ”€â”€ boughter.csv                      â† Stage 1: Translated proteins (1,117)
    â”‚
    â”œâ”€â”€ fragments/                        â† Stages 2+3: Fragment CSVs
    â”‚   â”œâ”€â”€ VH_only_boughter.csv          â”‚  (16 fragment files, 1,065 sequences)
    â”‚   â”œâ”€â”€ ... (15 more files)           â”‚
    â”‚   â”œâ”€â”€ annotation_failures.log       â”‚
    â”‚   â”œâ”€â”€ qc_filtered_sequences.txt     â”‚
    â”‚   â””â”€â”€ validation_report.txt         â”‚
    â”‚
    â”œâ”€â”€ canonical/                        â† Training file
    â”‚   â”œâ”€â”€ VH_only_boughter_training.csv â”‚  (914 sequences)
    â”‚   â””â”€â”€ README.md
    â”‚
    â””â”€â”€ strict_qc/                        â† Stage 4 optional
        â””â”€â”€ ... (16 strict QC files)
```

**Pros:**
- âœ… Simpler structure, fewer directories
- âœ… `canonical/` still makes training file obvious
- âœ… `fragments/` matches `test_datasets/` naming

**Cons:**
- Stage 1 output (`boughter.csv`) still floating in middle level
- Less clear stage progression

---

## Recommended Choice: **Option A** ğŸ¯

**Rationale:**
1. **Consistency with test_datasets philosophy:** Each stage has its own subdirectory
2. **Traceability:** Easy to see exactly where each file comes from
3. **Documentation clarity:** `canonical/README.md` can explain what makes this THE training file
4. **Future-proof:** If we add more datasets (Jain training? Shehata training?), same structure applies

---

## File Moves Required

### From Current to Option A

```bash
# 1. Create new subdirectories
mkdir -p train_datasets/boughter/processed
mkdir -p train_datasets/boughter/annotated
mkdir -p train_datasets/boughter/canonical
mkdir -p train_datasets/boughter/strict_qc

# 2. Move raw files (keep current location as boughter/raw/)
git mv train_datasets/boughter_raw train_datasets/boughter/raw

# 3. Move Stage 1 output
git mv train_datasets/boughter.csv train_datasets/boughter/processed/boughter.csv

# 4. Move Stage 2+3 fragment files (16 standard files)
git mv train_datasets/boughter/VH_only_boughter.csv train_datasets/boughter/annotated/
git mv train_datasets/boughter/VL_only_boughter.csv train_datasets/boughter/annotated/
# ... (repeat for all 16 fragment files)

# 5. Move training subset to canonical
git mv train_datasets/boughter/VH_only_boughter_training.csv train_datasets/boughter/canonical/

# 6. Move strict QC files (16 files)
git mv train_datasets/boughter/*_strict_qc.csv train_datasets/boughter/strict_qc/

# 7. Move log files
git mv train_datasets/boughter/annotation_failures.log train_datasets/boughter/annotated/
git mv train_datasets/boughter/qc_filtered_sequences.txt train_datasets/boughter/annotated/
git mv train_datasets/boughter/validation_report.txt train_datasets/boughter/annotated/

# 8. Keep existing README in boughter/
# (Already at train_datasets/boughter/README.md)
```

---

## Scripts That Need Path Updates

### Processing Scripts

**`preprocessing/boughter/stage1_dna_translation.py`:**
```python
# BEFORE:
input_dir = "train_datasets/boughter_raw"
output_file = "train_datasets/boughter.csv"
log_file = "train_datasets/boughter_raw/translation_failures.log"

# AFTER:
input_dir = "train_datasets/boughter/raw"
output_file = "train_datasets/boughter/processed/boughter.csv"
log_file = "train_datasets/boughter/raw/translation_failures.log"
```

**`preprocessing/boughter/stage2_stage3_annotation_qc.py`:**
```python
# BEFORE:
input_file = "train_datasets/boughter.csv"
output_dir = "train_datasets/boughter"
training_output = "train_datasets/boughter/VH_only_boughter_training.csv"

# AFTER:
input_file = "train_datasets/boughter/processed/boughter.csv"
output_dir = "train_datasets/boughter/annotated"
training_output = "train_datasets/boughter/canonical/VH_only_boughter_training.csv"
```

**`preprocessing/boughter/stage4_additional_qc.py`:**
```python
# BEFORE:
input_dir = "train_datasets/boughter"
output_suffix = "_strict_qc.csv"

# AFTER:
input_dir = "train_datasets/boughter/annotated"
output_dir = "train_datasets/boughter/strict_qc"
output_suffix = "_strict_qc.csv"
```

---

### Validation Scripts

**`preprocessing/boughter/validate_stage1.py`:**
```python
# BEFORE:
csv_file = "train_datasets/boughter.csv"

# AFTER:
csv_file = "train_datasets/boughter/processed/boughter.csv"
```

**`preprocessing/boughter/validate_stages2_3.py`:**
```python
# BEFORE:
fragment_dir = "train_datasets/boughter"
training_file = "train_datasets/boughter/VH_only_boughter_training.csv"

# AFTER:
fragment_dir = "train_datasets/boughter/annotated"
training_file = "train_datasets/boughter/canonical/VH_only_boughter_training.csv"
```

**`preprocessing/boughter/validate_stage4.py`:**
```python
# BEFORE:
strict_qc_dir = "train_datasets/boughter"
pattern = "*_strict_qc.csv"

# AFTER:
strict_qc_dir = "train_datasets/boughter/strict_qc"
pattern = "*_strict_qc.csv"
```

---

### Training Script

**`train.py`:**
```python
# Uses config.yaml, so we only need to update the config file!
```

**`configs/config.yaml`:**
```yaml
# BEFORE:
data:
  train_path: "train_datasets/boughter/VH_only_boughter_training.csv"

# AFTER:
data:
  train_path: "train_datasets/boughter/canonical/VH_only_boughter_training.csv"
```

**`configs/config_strict_qc.yaml`:**
```yaml
# BEFORE:
data:
  train_path: "train_datasets/boughter/VH_only_boughter_strict_qc.csv"

# AFTER:
data:
  train_path: "train_datasets/boughter/strict_qc/VH_only_boughter_strict_qc.csv"
```

---

## Documentation Updates Required

### Primary Documents

1. **`train_datasets/BOUGHTER_DATA_PROVENANCE.md`** (18 path references)
   - Update all directory structure diagrams
   - Update pipeline flow diagrams
   - Update file path examples

2. **`train_datasets/boughter/README.md`** (12 path references)
   - Update inputs/outputs for each stage
   - Update directory structure overview

3. **`preprocessing/boughter/README.md`** (15 path references)
   - Update script usage examples
   - Update input/output paths

### Supporting Documents

4. **`docs/boughter/BOUGHTER_DATASET_COMPLETE_HISTORY.md`**
5. **`docs/boughter/BOUGHTER_NOVO_REPLICATION_ANALYSIS.md`**
6. **`docs/boughter/BOUGHTER_ADDITIONAL_QC_PLAN.md`**
7. **`docs/boughter/boughter_processing_status.md`**
8. **`docs/TRAINING_READINESS_CHECK.md`**
9. **`docs/TRAINING_SETUP_STATUS.md`**

---

## New READMEs to Create

### `train_datasets/README.md` (NEW)

```markdown
# Training Datasets

This directory contains all training datasets for the antibody non-specificity classifier.

## Current Datasets

### Boughter 2020 (Primary Training Dataset)

**Source:** Boughter et al. (2020) eLife 9:e61393
**Size:** 914 training sequences (1,117 original â†’ 1,065 QC-passed â†’ 914 training-eligible)
**Labeling:** Novo Nordisk flagging strategy (0 flags = specific, 4+ flags = non-specific)

**Directory:** `boughter/`

**Key Files:**
- `boughter/canonical/VH_only_boughter_training.csv` - PRIMARY TRAINING FILE (914 sequences)
- `boughter/raw/` - Original DNA sequences from AIMS_manuscripts repository
- `boughter/processed/boughter.csv` - Translated protein sequences (Stage 1 output)
- `boughter/annotated/` - ANARCI-annotated fragments (16 types, Stages 2+3)

**Documentation:**
- [BOUGHTER_DATA_PROVENANCE.md](BOUGHTER_DATA_PROVENANCE.md) - Complete data lineage
- [boughter/README.md](boughter/README.md) - Preprocessing pipeline details

---

## Directory Structure

train_datasets/
â”œâ”€â”€ README.md (this file)
â”œâ”€â”€ BOUGHTER_DATA_PROVENANCE.md
â””â”€â”€ boughter/
    â”œâ”€â”€ raw/ - Original DNA FASTA files
    â”œâ”€â”€ processed/ - Stage 1: Translated proteins
    â”œâ”€â”€ annotated/ - Stages 2+3: ANARCI fragments
    â”œâ”€â”€ canonical/ - Authoritative training file
    â””â”€â”€ strict_qc/ - Stage 4: Experimental strict QC

---

## Adding New Training Datasets

When adding new training datasets (e.g., from other publications):

1. Create a new subdirectory: `train_datasets/<dataset_name>/`
2. Use the same structure: `raw/`, `processed/`, `annotated/`, `canonical/`
3. Create `<dataset_name>/README.md` documenting the preprocessing pipeline
4. Update this README with the new dataset information
5. Follow the same quality control standards as Boughter

---

**Last Updated:** 2025-11-05
```

---

### `train_datasets/boughter/canonical/README.md` (NEW)

```markdown
# Boughter Training Data - Canonical Files

This directory contains the **authoritative training file** for the Boughter 2020 dataset.

---

## Primary Training File

**`VH_only_boughter_training.csv`** - 914 sequences

This is the file used to train the ESM-1v + Logistic Regression classifier.

### Label Definition (Novo Nordisk Flagging)

The `label` column is derived from the Novo Nordisk flagging strategy:

- **label=0 (Specific):** 0 polyreactivity flags (461 sequences â†’ 443 after QC)
- **label=1 (Non-specific):** 4+ polyreactivity flags (487 sequences â†’ 471 after QC)

**Excluded:** Sequences with 1-3 flags (mild polyreactivity) are excluded from training.

### Columns

- `id` - Unique sequence identifier
- `vh_sequence` - VH domain amino acid sequence (ANARCI-annotated)
- `label` - Binary classification label (0=specific, 1=non-specific)
- `subset` - Original source subset (flu, hiv_nat, gut_hiv, etc.)
- `num_flags` - Number of polyreactivity flags (0-7 ligands)
- `source` - "Boughter2020"
- `include_in_training` - Always True in this file (pre-filtered)

### Statistics

```
Total sequences:       914
  Specific (label=0):   443 (48.5%)
  Non-specific (1):     471 (51.5%)

Label Balance:         1.06:1 (well-balanced)
```

---

## Provenance

**Generated by:** `preprocessing/boughter/stage2_stage3_annotation_qc.py`
**Source:** `train_datasets/boughter/processed/boughter.csv` (1,117 sequences)
**Processing:**
1. ANARCI annotation (IMGT numbering) â†’ 1,110 sequences
2. QC filtering (no X in CDRs, no empty CDRs) â†’ 1,065 sequences
3. Novo flagging filter (exclude 1-3 flags) â†’ 914 sequences

**Documentation:** See `train_datasets/BOUGHTER_DATA_PROVENANCE.md` for complete lineage

---

## Usage

```python
import pandas as pd

# Load training data
df = pd.read_csv('train_datasets/boughter/canonical/VH_only_boughter_training.csv', comment='#')

sequences = df['vh_sequence'].tolist()
labels = df['label'].values

print(f"Loaded {len(sequences)} training sequences")
print(f"Label distribution: {pd.Series(labels).value_counts().to_dict()}")
```

---

**Last Updated:** 2025-11-05
```

---

### `train_datasets/boughter/strict_qc/README.md` (NEW)

```markdown
# Boughter Strict QC Files (Experimental)

This directory contains **experimental** fragment files with additional strict quality control filters applied (Stage 4).

---

## Purpose

These files were generated as part of an experimental investigation to determine if stricter QC criteria could improve model performance.

**Result:** No significant improvement observed. Standard QC (Stages 2+3) is sufficient.

**See:** `docs/boughter/BOUGHTER_ADDITIONAL_QC_PLAN.md` for details.

---

## Files

16 fragment files with `_strict_qc.csv` suffix:
- `VH_only_boughter_strict_qc.csv`
- `H-CDR1_boughter_strict_qc.csv`
- ... (14 more)

**Sequence Count:** Varies by fragment (additional sequences filtered)

---

## Strict QC Criteria (Beyond Stage 3)

Stage 4 applies these additional filters:
- Filter 1: [Document specific criteria]
- Filter 2: [Document specific criteria]
- ... (TODO: Update from stage4 script)

---

## Usage

**Training Config:** Use `configs/config_strict_qc.yaml` to train on these files.

```bash
python3 train.py --config configs/config_strict_qc.yaml
```

**Note:** Standard training uses `configs/config.yaml` (recommended).

---

**Generated by:** `preprocessing/boughter/stage4_additional_qc.py`
**Last Updated:** 2025-11-05
```

---

## Benefits of This Reorganization

1. **ğŸ¯ Clarity:** Any developer can immediately see the data pipeline flow
2. **ğŸ“š Consistency:** Matches the clean structure we built for `test_datasets/`
3. **ğŸ” Traceability:** Every file's origin is obvious from its directory location
4. **ğŸš€ Scalability:** Easy to add new training datasets (same structure)
5. **ğŸ“– Documentation:** `canonical/README.md` explains what THE training file is
6. **ğŸ§ª Separation:** Experimental files (`strict_qc/`) clearly separated from production files
7. **ğŸ”’ Git History:** Using `git mv` preserves full file history

---

## Risk Assessment

### Low Risk âœ…
- All moves use `git mv` (history preserved)
- Scripts are well-documented and easy to update
- Validation scripts will catch any path errors
- Can revert with `git reset --hard` if needed

### Medium Risk âš ï¸
- Many scripts need path updates (~6-8 Python files)
- Many docs need path updates (~9 markdown files)
- Must test all scripts after reorganization

### Mitigation ğŸ›¡ï¸
- Create comprehensive todo list for all updates
- Update one stage at a time (Stage 1 â†’ Stage 2+3 â†’ Stage 4)
- Run validation scripts after each stage
- Test training pipeline with `train.py` at the end
- Senior review before execution

---

## Estimated Effort

- **File moves:** 15 minutes (scripted with bash/git mv)
- **Script updates:** 30 minutes (6-8 Python files)
- **Config updates:** 5 minutes (2 YAML files)
- **Documentation updates:** 45 minutes (9 markdown files)
- **New READMEs:** 20 minutes (3 new files)
- **Testing/Validation:** 20 minutes (run all validation scripts)

**Total:** ~2.5 hours

---

## Next Steps

1. **Get senior approval on Option A vs Option B** âœ… (REQUIRED BEFORE PROCEEDING)
2. Create detailed todo list for execution
3. Execute file moves (with `git mv`)
4. Update scripts and configs
5. Update documentation
6. Create new READMEs
7. Run all validation scripts
8. Test training pipeline
9. Commit with descriptive message

---

## Questions for Senior Review

1. **Structure choice:** Option A (full pipeline visibility) or Option B (simpler)?
2. **Naming:** `annotated/` vs `fragments/` for Stages 2+3 outputs?
3. **Stage 4 files:** Keep `strict_qc/` subdirectory or move to separate experimental directory?
4. **Git commit strategy:** One big commit or separate commits per stage?
5. **Training config:** Should default `config.yaml` change or stay as-is?

---

**Document Version:** 1.0
**Author:** Claude Code
**Status:** ğŸ“‹ AWAITING SENIOR APPROVAL
**Last Updated:** 2025-11-05
