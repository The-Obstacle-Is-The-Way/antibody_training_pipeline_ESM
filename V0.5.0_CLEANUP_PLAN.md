# v0.5.0 Cleanup Plan - Legacy Config Removal & Final Code Hygiene

**Status**: ðŸ“‹ PLANNING - Awaiting Senior Review
**Created**: 2025-11-15
**Target Release**: v0.5.0
**Estimated Effort**: 4-6 hours execution + testing

---

## Executive Summary

**Goal**: Remove all legacy configuration infrastructure (`configs/config.yaml` + `train_model()`), clean up stale documentation, and achieve 100% Hydra-based configuration system.

**Scope**:
- âœ… **Problem 1**: Remove `configs/config.yaml` and legacy `train_model()` function (2-3h)
- âœ… **Problem 2**: Archive stale documentation with configs/ references (1-2h)
- âœ… **Problem 3**: Final validation and testing (1h)
- âš ï¸ **Problem 4**: Experiments directory reorganization (OPTIONAL - 1h)

**Breaking Changes**: YES - `train_model(config_path)` API removed (already deprecated since v0.4.0)

**Migration Path**: All users must migrate to Hydra-based `train_pipeline(cfg)` (migration guide provided)

---

## Audit Results Summary

### configs/config.yaml Dependencies (2 Active)

**Production Code**:
```python
# 1. src/antibody_training_esm/core/trainer.py:793
def train_model(config_path: str = "configs/config.yaml") -> dict[str, Any]:
    # DEPRECATED: Already emits DeprecationWarning
```

**Preprocessing Scripts**:
```python
# 2. preprocessing/boughter/train_hyperparameter_sweep.py:279
def main(config_path: str | Path = "configs/config.yaml") -> int:
```

**Tests**:
- `tests/unit/core/test_trainer.py` - Tests deprecation warning (good!)
- `tests/e2e/test_train_pipeline.py` - Uses `train_model()` in 2 tests

**Documentation References**: 17 files mention `configs/config.yaml` (majority in `docs/archive/`, remainder in experiment docs)

### Path Centralization Status âœ… ALREADY EXCELLENT

**Dataset Paths**: âœ… Centralized in `src/antibody_training_esm/datasets/default_paths.py`
```python
BOUGHTER_ANNOTATED_DIR = Path("data/train/boughter/annotated")
HARVEY_OUTPUT_DIR = Path("data/test/harvey/fragments")
JAIN_OUTPUT_DIR = Path("data/test/jain/fragments")
SHEHATA_OUTPUT_DIR = Path("data/test/shehata/fragments")
# ... 10 total constants
```

**Embeddings Cache**: âœ… Centralized in `src/antibody_training_esm/conf/config_schema.py`
```python
embeddings_cache_dir: str = "./embeddings_cache"
```

**Model Output Paths**: âœ… Centralized in `src/antibody_training_esm/core/directory_utils.py`
```python
def get_model_directory(model_name: str, classifier_type: str) -> Path:
    # Returns: models/{model_shortname}/{classifier_type}/
```

**Remaining Hard-Coded Paths**: 116 references to "data/" found
- **Analysis**: 95%+ are in docstrings, comments, or preprocessing scripts (LEGITIMATE)
- **Examples**:
  - Dataset module docstrings (user documentation)
  - Preprocessing scripts defining data flow (by design)
  - Error messages with helpful path hints (user-facing)
- **Action**: NO CHANGES NEEDED - paths are appropriately centralized where it matters

### Magic Numbers Status âœ… CLEAN

**Thresholds**: âœ… Already centralized
```python
# src/antibody_training_esm/core/classifier.py
ASSAY_THRESHOLDS = {
    "ELISA": 0.5,
    "PSR": 0.5495,  # Novo Nordisk exact parity
}
```

**No problematic magic numbers found** in audit (grep for `[0-9]+\.[0-9]+`).

### Code Quality Status âœ… EXCELLENT

- **TODO comments**: 0 in src/
- **FIXME comments**: 0 in src/
- **Deprecation warnings**: âœ… Already in place for `train_model()`

---

## Problem 1: Remove configs/config.yaml and Legacy train_model()

### Current State

**Files to Remove**:
```
configs/
â””â”€â”€ config.yaml (82 lines)
```

**Functions to Remove**:
```python
# src/antibody_training_esm/core/trainer.py:793-850 (58 lines)
def train_model(config_path: str = "configs/config.yaml") -> dict[str, Any]:
    """Legacy training function (DEPRECATED)"""
```

**Migration Status**:
- âœ… Deprecation warning added (emits `DeprecationWarning` since v0.4.0)
- âœ… Modern API available: `train_pipeline(cfg)` with Hydra
- âœ… All production code uses Hydra (antibody-train CLI)
- âš ï¸ 2 preprocessing scripts still use old API
- âš ï¸ 2 e2e tests use old API

### Target State

```
configs/          # DELETED
```

```python
# src/antibody_training_esm/core/trainer.py
# train_model() function REMOVED (lines 793-850 deleted)
```

All code uses Hydra-based `train_pipeline(cfg)`.

### Execution Plan

#### Step 1: Update Preprocessing Scripts (30 min)

**File**: `preprocessing/boughter/train_hyperparameter_sweep.py:279`

**Change**:
```python
# BEFORE
def main(config_path: str | Path = "configs/config.yaml") -> int:
    """Run hyperparameter sweep with grid search."""
    config_path = Path(config_path)
    with open(config_path) as f:
        config = yaml.safe_load(f)

# AFTER
def main(config_path: str | Path = "src/antibody_training_esm/conf/config.yaml") -> int:
    """Run hyperparameter sweep with grid search."""
    from hydra import compose, initialize_config_dir
    from pathlib import Path

    # Use Hydra to load config
    config_dir = Path("src/antibody_training_esm/conf").resolve()
    with initialize_config_dir(config_dir=str(config_dir)):
        cfg = compose(config_name="config")
        config = OmegaConf.to_container(cfg, resolve=True)
```

**Verification**:
```bash
grep "configs/config.yaml" preprocessing/boughter/train_hyperparameter_sweep.py
# Should return empty
```

#### Step 2: Update Tests (45 min)

**File**: `tests/e2e/test_train_pipeline.py`

**Strategy**: Migrate e2e tests to use `train_pipeline(cfg)` instead of `train_model(config_path)`

**Changes**:
```python
# BEFORE
from antibody_training_esm.core.trainer import train_model

def test_train_end_to_end(mock_training_config):
    results = train_model(str(mock_training_config))

# AFTER
from antibody_training_esm.core.trainer import train_pipeline
from hydra import compose, initialize_config_dir
from omegaconf import OmegaConf

def test_train_end_to_end(tmp_path):
    # Create Hydra config
    with initialize_config_dir(config_dir=str(tmp_path)):
        cfg = compose(config_name="config")
        results = train_pipeline(cfg)
```

**File**: `tests/unit/core/test_trainer.py`

**Strategy**: Remove test for deprecated `train_model()` or convert to test that function is deleted

**Changes**:
```python
# DELETE THIS TEST (tests deprecated function)
def test_train_model_deprecation_warning():
    with pytest.warns(DeprecationWarning, match="train_model.*deprecated"):
        train_model(str(config_file))
```

**Verification**:
```bash
grep -r "train_model(" tests/
# Should return empty (no calls to old API)

uv run pytest tests/unit/core/test_trainer.py -v
uv run pytest tests/e2e/test_train_pipeline.py -v
# All tests must pass
```

#### Step 3: Remove Legacy Code (15 min)

**Delete function**:
```bash
# Verify current line numbers
grep -n "def train_model" src/antibody_training_esm/core/trainer.py

# Use Edit tool to remove lines 793-850
```

**Delete directory**:
```bash
git rm -r configs/
```

**Verification**:
```bash
# No imports of deleted function
grep -r "from.*trainer import train_model" src/ tests/
# Should return empty

# No references to deleted config
grep -r "configs/config.yaml" --include="*.py" src/ tests/ preprocessing/
# Should return empty

# All tests pass
uv run pytest tests/unit/ -v
uv run pytest tests/integration/ -v
```

#### Step 4: Update Documentation (30 min)

**Files to update**:
- `CLAUDE.md` - Remove any `configs/config.yaml` references
- `README.md` - Verify no legacy config references
- `docs/developer-guide/development-workflow.md` - Update training examples

**Add migration guide**:
Create `docs/migration/v0.4.0-to-v0.5.0.md`:
```markdown
# Migration Guide: v0.4.0 â†’ v0.5.0

## Breaking Changes

### configs/config.yaml Removed

**Old API (REMOVED)**:
```python
from antibody_training_esm.core.trainer import train_model
results = train_model("configs/config.yaml")
```

**New API (USE THIS)**:
```python
# CLI (recommended)
uv run antibody-train  # Uses Hydra configs automatically

# Python API
from antibody_training_esm.core.trainer import train_pipeline
from hydra import compose, initialize

with initialize(config_path="../src/antibody_training_esm/conf"):
    cfg = compose(config_name="config")
    results = train_pipeline(cfg)
```

## Migration Checklist

- [ ] Replace all `train_model(config_path)` calls with `train_pipeline(cfg)`
- [ ] Update config paths: `configs/config.yaml` â†’ `src/antibody_training_esm/conf/config.yaml`
- [ ] Use Hydra overrides for config changes: `antibody-train model.device=cuda`
- [ ] Remove any hard-coded `configs/` directory references
```

**Update CHANGELOG**:
```markdown
# v0.5.0 (TBD)

## Breaking Changes
- **Removed** `configs/config.yaml` (use `src/antibody_training_esm/conf/config.yaml` with Hydra)
- **Removed** `train_model(config_path)` function (use `train_pipeline(cfg)` with Hydra)

## Migration
- See `docs/migration/v0.4.0-to-v0.5.0.md` for migration guide
- All training now uses Hydra configuration system
- CLI unchanged: `antibody-train` continues to work

## Improvements
- 100% Hydra-based configuration (no legacy YAML loading)
- Cleaner repository structure (no root configs/ directory)
- Simplified testing (no dual config systems)
```

### Success Criteria - Problem 1

- [ ] `configs/` directory deleted (verified with `ls configs/` returning error)
- [ ] `train_model()` function removed from `trainer.py`
- [ ] Zero references to `configs/config.yaml` in production code (grep returns empty)
- [ ] Zero imports of `train_model` in codebase (grep returns empty)
- [ ] All tests pass: `uv run pytest tests/ -v` (100% pass rate)
- [ ] Migration guide created: `docs/migration/v0.4.0-to-v0.5.0.md`
- [ ] CHANGELOG updated with breaking changes
- [ ] CLAUDE.md updated (no legacy config references)

---

## Problem 2: Archive Stale Documentation

### Current State

**Documentation with configs/ references**: 17 files (docs/archive/, experiments/strict_qc_2025-11-04/, docs_burner/, and this plan)
- `docs/archive/*.md` (19 files) - Old migration plans, audit reports
- `experiments/strict_qc_2025-11-04/docs/*.md` (8 files) - Experimental docs

**Analysis**:
- Most are already in `docs/archive/` (good!)
- Some in `experiments/` subdirectories (should stay - historical record)
- Core docs (`CLAUDE.md`, `README.md`) have minimal stale references

### Target State

- Core documentation (`docs/`, `CLAUDE.md`, `README.md`) has ZERO `configs/config.yaml` references
- Archived documentation clearly marked as HISTORICAL
- Experimental docs preserved as-is (historical context)

### Execution Plan

#### Step 1: Update Core Documentation (30 min)

**Files to scan**:
```bash
grep -l "configs/config.yaml" CLAUDE.md README.md docs/*.md docs/developer-guide/*.md
```

**Changes**:
- Replace `configs/config.yaml` with `src/antibody_training_esm/conf/config.yaml`
- Update code examples to use Hydra
- Add deprecation notices where appropriate

**Verification**:
```bash
grep "configs/config.yaml" CLAUDE.md README.md docs/**/*.md | grep -v "docs/archive"
# Should return empty (except archive docs)
```

#### Step 2: Mark Archived Docs as Historical (15 min)

Add header to all `docs/archive/*.md` files:
```markdown
> **âš ï¸ HISTORICAL DOCUMENT**: This document references legacy `configs/config.yaml` which was removed in v0.5.0. For current documentation, see `docs/`.
```

**Script**:
```bash
for file in docs/archive/*.md; do
  # Add historical notice at top
  sed -i '' '1i\
> **âš ï¸ HISTORICAL DOCUMENT**: This document references legacy `configs/config.yaml` which was removed in v0.5.0. For current documentation, see `docs/`.\
\

  ' "$file"
done
```

**Verification**:
```bash
head -3 docs/archive/*.md
# All should show historical notice
```

#### Step 3: Clean Up Experiments Documentation (15 min)

**Strategy**: Leave experiments/ docs as-is (historical record), but add README.md to clarify status

**Create**: `experiments/strict_qc_2025-11-04/docs/README.md`
```markdown
# Strict QC Experiment Documentation (2025-11-04)

**Status**: ARCHIVED - Historical experiment documentation

This directory contains documentation from the strict QC filtering experiment conducted on 2025-11-04. References to `configs/config.yaml` are preserved as historical context.

**For current documentation**, see the main `docs/` directory.
```

**Similar READMEs for**:
- `experiments/novo_parity/docs/` (if exists)
- `experiments/archive/hyperparameter_sweeps_2025-11-02/` (if docs exist)

### Success Criteria - Problem 2

- [ ] Zero `configs/config.yaml` references in core docs (CLAUDE.md, README.md, docs/*.md, docs/developer-guide/*.md)
- [ ] All `docs/archive/*.md` files have historical notice header
- [ ] Experiment docs have README.md clarifying archived status
- [ ] No breaking changes to archived docs (preserve historical accuracy)

---

## Problem 3: Final Validation and Testing

### Validation Checklist

#### Code Validation (30 min)

```bash
# 1. No legacy imports
grep -r "from.*trainer import train_model" src/ tests/ preprocessing/
# Expected: Empty

# 2. No legacy config references
grep -r "configs/config.yaml" --include="*.py" src/ tests/ preprocessing/
# Expected: Empty

# 3. No legacy directory references
ls configs/
# Expected: Error (directory should not exist)

# 4. All imports valid
uv run python -c "from antibody_training_esm.core.trainer import train_pipeline; print('âœ… Imports valid')"
# Expected: âœ… Imports valid

# 5. Type checking passes
make typecheck
# Expected: All checks passed

# 6. Linting passes
make lint
# Expected: No issues found

# 7. Formatting clean
make format
# Expected: No changes (already formatted)
```

#### Test Validation (30 min)

```bash
# 1. Unit tests
uv run pytest tests/unit/ -v
# Expected: 100% pass rate

# 2. Integration tests
uv run pytest tests/integration/ -v
# Expected: 100% pass rate

# 3. E2E tests (critical - tests removed train_model())
uv run pytest tests/e2e/ -v
# Expected: 100% pass rate (with updated Hydra-based tests)

# 4. Coverage check
uv run pytest --cov=src/antibody_training_esm --cov-report=term-missing --cov-fail-under=70
# Expected: â‰¥70% coverage maintained

# 5. Specific trainer tests
uv run pytest tests/unit/core/test_trainer.py -v
# Expected: All pass, no deprecation warning tests
```

#### End-to-End Pipeline Validation (15 min)

```bash
# 1. Training CLI works
uv run antibody-train --help
# Expected: Help text displayed

# 2. Training with overrides works
uv run antibody-train hardware.device=cpu training.batch_size=2
# Expected: Training starts (can Ctrl+C after first batch)

# 3. Config composition works
uv run antibody-train --cfg job
# Expected: Displays composed Hydra config

# 4. No Hydra errors
uv run antibody-train 2>&1 | grep -i "error"
# Expected: No Hydra composition errors
```

#### Documentation Validation (15 min)

```bash
# 1. Core docs clean
grep "configs/config.yaml" CLAUDE.md README.md
# Expected: Empty

# 2. Migration guide exists
ls docs/migration/v0.4.0-to-v0.5.0.md
# Expected: File exists

# 3. CHANGELOG updated
grep "v0.5.0" CHANGELOG.md
# Expected: v0.5.0 entry with breaking changes

# 4. Archive docs marked
head -3 docs/archive/2025-11-11-production-readiness-audit.md
# Expected: HISTORICAL DOCUMENT notice
```

### Success Criteria - Problem 3

- [ ] All code validation checks pass (7/7)
- [ ] All test validation checks pass (5/5)
- [ ] All pipeline validation checks pass (4/4)
- [ ] All documentation validation checks pass (4/4)
- [ ] Zero regressions in existing functionality
- [ ] CI/CD pipeline passes (Docker CI/CD, CI Pipeline, CodeQL)

---

## Problem 4: Experiments Directory Reorganization (OPTIONAL)

**Status**: OPTIONAL - Not blocking for v0.5.0

### Current State

```
experiments/
â”œâ”€â”€ README.md
â”œâ”€â”€ archive/
â”‚   â””â”€â”€ hyperparameter_sweeps_2025-11-02/ (22 files)
â”œâ”€â”€ hyperparameter_sweeps/ (empty or minimal)
â”œâ”€â”€ novo_parity/
â””â”€â”€ strict_qc_2025-11-04/
```

### Potential Improvements (Future Work)

1. **Consolidate archived experiments** under `experiments/archive/`
   - Move `strict_qc_2025-11-04/` â†’ `experiments/archive/strict_qc_2025-11-04/`
   - Keep `novo_parity/` active (validated results)

2. **Create experiments organization guide**
   - Document when to archive vs keep active
   - Define naming conventions for experiments
   - Clarify gitignore strategy for outputs/

3. **Clean up empty directories**
   - Remove `experiments/hyperparameter_sweeps/` if empty

**Decision**: DEFER to post-v0.5.0 (does not block config removal)

---

## Execution Timeline

| Task | Duration | Dependencies | Priority |
|------|----------|--------------|----------|
| **Problem 1** | | | |
| Update preprocessing scripts | 30 min | None | P0 |
| Update tests | 45 min | None | P0 |
| Remove legacy code | 15 min | Tests updated | P0 |
| Update documentation | 30 min | Code removed | P0 |
| **Problem 2** | | | |
| Update core docs | 30 min | None | P1 |
| Mark archived docs | 15 min | None | P2 |
| Clean up experiments docs | 15 min | None | P2 |
| **Problem 3** | | | |
| Code validation | 30 min | Problem 1 complete | P0 |
| Test validation | 30 min | Problem 1 complete | P0 |
| Pipeline validation | 15 min | Problem 1 complete | P0 |
| Documentation validation | 15 min | Problem 2 complete | P1 |
| **TOTAL** | **4h 30min** | | |

**Estimated with buffer**: 6 hours (includes troubleshooting)

---

## Risk Assessment

### High Risk Items

1. **Test Breakage** - e2e tests may fail after removing `train_model()`
   - **Mitigation**: Update tests BEFORE removing function
   - **Rollback**: Keep function as no-op with error message for one release

2. **Preprocessing Script Failures** - Hyperparameter sweep script may break
   - **Mitigation**: Test locally before committing
   - **Rollback**: Can keep old API with deprecation warning for one more release

### Medium Risk Items

1. **Documentation Gaps** - Users may not find migration guide
   - **Mitigation**: Add prominent notice in CHANGELOG and README
   - **Rollback**: None needed (docs can be updated post-release)

2. **Hidden Dependencies** - Undiscovered code using `configs/config.yaml`
   - **Mitigation**: Comprehensive grep audit (already done)
   - **Rollback**: Restore configs/ from git history

### Low Risk Items

1. **CI/CD Pipeline** - Should pass (no breaking changes to Docker/workflows)
2. **Path Centralization** - Already complete, no changes needed
3. **Magic Numbers** - Already clean, no changes needed

---

## Success Criteria (Overall)

### Code Quality
- [ ] `configs/` directory removed
- [ ] `train_model()` function removed
- [ ] Zero `configs/config.yaml` references in src/, tests/, preprocessing/
- [ ] Zero imports of removed function
- [ ] 100% type checking passes (mypy)
- [ ] 100% linting passes (ruff)
- [ ] Zero TODO/FIXME comments introduced

### Testing
- [ ] All unit tests pass (100%)
- [ ] All integration tests pass (100%)
- [ ] All e2e tests pass (100%)
- [ ] Coverage â‰¥70% maintained
- [ ] CI/CD pipeline passes (Docker CI/CD, CI Pipeline, CodeQL)

### Documentation
- [ ] Migration guide created (`docs/migration/v0.4.0-to-v0.5.0.md`)
- [ ] CHANGELOG updated with breaking changes
- [ ] CLAUDE.md updated (no legacy references)
- [ ] README.md updated (no legacy references)
- [ ] Archived docs marked as HISTORICAL
- [ ] Core docs clean (zero `configs/config.yaml` references)

### Validation
- [ ] Training CLI works: `uv run antibody-train`
- [ ] Config overrides work: `uv run antibody-train hardware.device=cpu`
- [ ] No Hydra composition errors
- [ ] All validation checks pass (20/20)

---

## Rollback Plan

If critical issues discovered post-release:

### Emergency Rollback (< 1 hour)
```bash
# Restore configs/config.yaml
git checkout v0.4.0 -- configs/

# Restore train_model() function
git checkout v0.4.0 -- src/antibody_training_esm/core/trainer.py

# Restore tests
git checkout v0.4.0 -- tests/unit/core/test_trainer.py tests/e2e/test_train_pipeline.py

# Commit rollback
git add -A
git commit -m "fix: Rollback v0.5.0 config removal (critical issues found)"
git push
```

### Partial Rollback (keep deprecation, delay removal)
```bash
# Keep configs/config.yaml but add DEPRECATED notice
echo "# DEPRECATED - See src/antibody_training_esm/conf/config.yaml" > configs/config.yaml
cat configs/config.yaml.backup >> configs/config.yaml

# Keep train_model() but make it error loudly
# (modify function to raise DeprecationError instead of warning)
```

---

## Post-Execution Checklist

After completing all tasks:

1. **Verification**:
   ```bash
   make all  # Run format, lint, typecheck, test
   ```

2. **Git Workflow**:
   ```bash
   git status
   git add -A
   git commit -m "feat: Remove legacy configs/ and train_model() (v0.5.0)"
   git push origin dev
   ```

3. **Senior Review**:
   - Create GitHub issue or PR for review
   - Link to this plan document
   - Highlight breaking changes
   - Show validation results (all checks passed)

4. **Release Preparation**:
   - Tag release: `git tag v0.5.0`
   - Update version in `pyproject.toml`
   - Publish CHANGELOG
   - Announce breaking changes to users

---

## Notes for Senior Review

**Question 1**: Should we keep `train_model()` as deprecated stub for one more release (v0.5.0 â†’ v0.6.0 removal)?
- **Pro**: Gentler migration path, clearer deprecation period
- **Con**: Delays cleanup, maintains dual API surface

**Question 2**: Should experiments/ reorganization (Problem 4) be included in v0.5.0 or deferred?
- **Current decision**: DEFER (not blocking)
- **Rationale**: Focus v0.5.0 on config removal only

**Question 3**: Are there any other legacy patterns to remove in v0.5.0?
- **Audit shows**: Path centralization âœ… complete, magic numbers âœ… clean, TODO/FIXME âœ… none
- **Recommendation**: v0.5.0 scope is complete as-is

**Question 4**: Should we add integration tests for Hydra config composition?
- **Current coverage**: E2E tests use Hydra implicitly
- **Recommendation**: Add explicit Hydra composition tests in tests/integration/

---

## References

- `docs_burner/REPOSITORY_CLEANUP_PLAN.md` (lines 373-406) - Original Problem 2 definition
- `docs_burner/TRAIN_DATASETS_CONSOLIDATION_PLAN.md` - Phase 2 completion example
- `CLAUDE.md` - Project conventions and development workflow
- `src/antibody_training_esm/conf/config.yaml` - Hydra config structure
- `src/antibody_training_esm/core/trainer.py` - Current trainer implementation

---

**Plan Status**: âœ… COMPLETE - Ready for senior review and approval

**Next Steps**:
1. Senior review this plan
2. Address any questions/concerns
3. Get approval to proceed
4. Execute plan (estimated 6 hours)
5. Validate all success criteria
6. Merge to main and tag v0.5.0
